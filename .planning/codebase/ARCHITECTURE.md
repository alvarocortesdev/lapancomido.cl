# Architecture

**Analysis Date:** 2026-01-30

## Pattern Overview

**Overall:** Monorepo with separate React SPA Frontend + Express REST API Backend

**Key Characteristics:**
- Client-server architecture with React frontend consuming Express REST API
- React Context API for global state management (Auth, Cart, Products)
- MVC-style backend with routes → controllers → models pattern
- PostgreSQL database with direct SQL queries (no ORM)
- JWT-based authentication with role-based access control

## Layers

**Frontend Presentation Layer:**
- Purpose: React components rendering UI and handling user interactions
- Location: `src/components/`, `src/pages/`
- Contains: React components (JSX), page views, UI elements
- Depends on: Context providers, custom hooks, helpers
- Used by: Router renders pages which compose components

**Frontend State Layer:**
- Purpose: Global state management via React Context
- Location: `src/context/`
- Contains: AuthProvider, CartProvider, ProductProvider
- Depends on: React, localStorage, API helpers
- Used by: Custom hooks expose context to components

**Frontend Routing Layer:**
- Purpose: Client-side routing and route protection
- Location: `src/router/RouterManager.jsx`, `src/guard/AuthGuard.jsx`
- Contains: React Router configuration, auth guards
- Depends on: react-router-dom, AuthContext
- Used by: App.jsx wraps entire application

**Frontend Service Layer:**
- Purpose: API communication and data fetching
- Location: `src/helpers/api.jsx`, `src/helpers/getProductData.helper.js`
- Contains: Fetch wrappers, data transformation functions
- Depends on: Browser fetch API, environment variables
- Used by: Context providers, hooks, pages

**Backend Routes Layer:**
- Purpose: HTTP endpoint definitions and request routing
- Location: `api/src/routes/`
- Contains: Express router configurations with Swagger documentation
- Depends on: Express, controllers, middlewares
- Used by: Main server mounts all routes under `/api`

**Backend Controller Layer:**
- Purpose: Request handling, business logic, response formatting
- Location: `api/src/controllers/`
- Contains: Async controller functions handling HTTP requests
- Depends on: Models, database, external services
- Used by: Routes invoke controller methods

**Backend Model Layer:**
- Purpose: Database access and data operations
- Location: `api/src/models/`
- Contains: SQL query functions for CRUD operations
- Depends on: PostgreSQL connection pool (`db.js`)
- Used by: Controllers call model functions

**Backend Middleware Layer:**
- Purpose: Request preprocessing, authentication, authorization
- Location: `api/src/middlewares/`
- Contains: Token validation, admin role checking
- Depends on: JWT, request headers
- Used by: Routes apply middleware before controllers

## Data Flow

**User Authentication Flow:**

1. User submits credentials via `LoginForm.jsx`
2. `src/helpers/api.jsx` sends POST to `/api/auth/login`
3. `auth.controller.js` validates credentials via `User` model
4. JWT token generated by `Auth.js` model and returned
5. `AuthProvider.jsx` decodes token, stores in state + localStorage (encrypted)
6. `useAuth()` hook exposes session to components
7. Protected routes check `session.token` via `AuthGuard.jsx`

**Product Display Flow:**

1. `ProductProvider.jsx` calls `getProducts()` on mount
2. `getProductData.helper.js` fetches from `/api/products`
3. `product.controller.js` queries PostgreSQL via raw SQL
4. Products stored in `ProductContext`, available via `useProducts()` hook
5. Pages like `CatalogPage.jsx` consume products from context

**Order Checkout Flow:**

1. User builds cart via `useCart()` hook (stored in `CartContext`)
2. `CheckoutPage.jsx` collects delivery info
3. POST to `/api/orders/confirm` with items array
4. `order.controller.js` runs transaction: verify stock → decrement → create order → add details
5. Success redirects to `SuccessPage.jsx`

**State Management:**
- **Auth state:** `AuthContext` + localStorage (encrypted via CryptoJS)
- **Cart state:** `CartContext` (in-memory only, cleared on logout)
- **Product state:** `ProductContext` (fetched on app mount)
- No Redux or external state library; pure React Context

## Key Abstractions

**Context Providers:**
- Purpose: Encapsulate global state with React Context pattern
- Examples: `src/context/AuthProvider.jsx`, `src/context/CartProvider.jsx`, `src/context/ProductProvider.jsx`
- Pattern: Create context, provide value, consume via custom hook

**Custom Hooks:**
- Purpose: Encapsulate context consumption and logic reuse
- Examples: `src/hooks/useAuth.jsx`, `src/hooks/useCart.jsx`, `src/hooks/useProducts.jsx`
- Pattern: Call `useContext()`, return destructured values with additional methods

**Layout Components:**
- Purpose: Shared page structure with nested routing
- Examples: `src/layouts/MainLayout.jsx`, `src/layouts/AuthLayout.jsx`, `src/layouts/AdminLayout.jsx`
- Pattern: Render common elements (Header, Footer) + `<Outlet />` for child routes

**Controller Functions:**
- Purpose: Handle HTTP requests with async/await pattern
- Examples: `api/src/controllers/auth.controller.js`, `api/src/controllers/product.controller.js`
- Pattern: `async (req, res, next) => { try { ... } catch { next(err) } }`

**Model Functions:**
- Purpose: Database queries returning row data
- Examples: `api/src/models/User.js`, `api/src/models/Product.js`
- Pattern: Parameterized SQL queries with `db.query()`, return `rows[0]` or `rows`

## Entry Points

**Frontend Entry:**
- Location: `src/main.jsx`
- Triggers: Browser loads `index.html`, Vite injects bundled JS
- Responsibilities: Render React root, mount `<App />` component

**Frontend App Root:**
- Location: `src/App.jsx`
- Triggers: Mounted by main.jsx
- Responsibilities: Wrap app with providers (Auth → Cart → Product), render RouterManager

**Backend Entry:**
- Location: `api/index.js`
- Triggers: `node index.js` or `nodemon index.js`
- Responsibilities: Load environment, start Express server on PORT

**Backend Server Setup:**
- Location: `api/src/server.js`
- Triggers: Required by `api/index.js`
- Responsibilities: Configure middleware (cors, morgan, json), mount routes, error handling

**API Route Index:**
- Location: `api/src/routes/routes.js`
- Triggers: Mounted at `/api` by server.js
- Responsibilities: Aggregate all feature routes under namespaced paths

## Error Handling

**Strategy:** 
- Frontend: try/catch in async operations, console.error for logging, toast notifications for user feedback
- Backend: Express error middleware catches unhandled errors, returns 500 JSON response

**Patterns:**
- Controllers pass errors to `next(err)` for centralized handling
- API helpers throw errors on non-ok responses
- 404 middleware for undefined routes in `server.js`
- Global error middleware logs stack trace, returns generic error message

## Cross-Cutting Concerns

**Logging:** 
- Backend: Morgan middleware for HTTP request logging (dev format)
- Frontend: console.error for caught exceptions

**Validation:** 
- Backend: Manual validation in controllers (check required fields, return 400)
- No schema validation library (Joi, Zod) currently used
- RUT validation helper: `api/src/helpers/validateRut.helper.js`

**Authentication:** 
- JWT tokens with 1-hour expiry
- Token validation middleware: `api/src/middlewares/validateToken.js`
- Role-based access: `api/src/middlewares/isAdmin.js` (allows "admin" and "developer" roles)
- Frontend stores encrypted session in localStorage

**Authorization:**
- Role check in middleware before admin routes
- Frontend conditionally renders admin routes based on `session.role`
- `AuthGuard.jsx` redirects unauthenticated users

---

*Architecture analysis: 2026-01-30*
