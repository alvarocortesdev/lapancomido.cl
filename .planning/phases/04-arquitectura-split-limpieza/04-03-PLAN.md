---
phase: 04-arquitectura-split-limpieza
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - apps/web/vercel.json
  - apps/admin/vercel.json
  - apps/api/vercel.json
  - apps/api/src/server.js
  - apps/admin/src/main.jsx
  - apps/admin/index.html
autonomous: false

user_setup:
  - service: vercel
    why: "Deploy de subdominios separados"
    env_vars:
      - name: DATABASE_URL
        source: "Ya configurada en Vercel - copiar a nuevos proyectos"
      - name: DIRECT_URL
        source: "Ya configurada en Vercel - copiar a nuevos proyectos"
    dashboard_config:
      - task: "Crear proyecto api.lapancomido.cl en Vercel"
        location: "Vercel Dashboard -> New Project -> Import from Git"
      - task: "Crear proyecto admin.lapancomido.cl en Vercel"
        location: "Vercel Dashboard -> New Project -> Import from Git"
      - task: "Configurar dominio api.lapancomido.cl"
        location: "Vercel Project -> Settings -> Domains"
      - task: "Configurar dominio admin.lapancomido.cl"
        location: "Vercel Project -> Settings -> Domains"

must_haves:
  truths:
    - "lapancomido.cl sirve el sitio p√∫blico"
    - "admin.lapancomido.cl sirve el shell del panel admin"
    - "api.lapancomido.cl responde a requests de ambos frontends"
    - "CORS configurado correctamente entre subdominios"
  artifacts:
    - path: "apps/web/vercel.json"
      provides: "Configuraci√≥n Vercel para web p√∫blico"
    - path: "apps/admin/vercel.json"
      provides: "Configuraci√≥n Vercel para admin"
    - path: "apps/api/vercel.json"
      provides: "Configuraci√≥n Vercel para API serverless"
    - path: "apps/api/src/server.js"
      provides: "CORS configurado para subdominios"
  key_links:
    - from: "apps/web"
      to: "api.lapancomido.cl"
      via: "API_URL env var"
      pattern: "fetch.*api\\.lapancomido\\.cl"
    - from: "apps/admin"
      to: "api.lapancomido.cl"
      via: "API_URL env var"
      pattern: "fetch.*api\\.lapancomido\\.cl"
---

<objective>
Configurar subdominios separados en Vercel para web p√∫blico, admin y API, con CORS correctamente configurado.

Purpose: Arquitectura split que permite deploys independientes y aislamiento de seguridad entre sitio p√∫blico y admin.
Output: Tres proyectos Vercel desplegados en subdominios, CORS funcionando.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-arquitectura-split-limpieza/04-CONTEXT.md
@.planning/phases/04-arquitectura-split-limpieza/04-01-SUMMARY.md
@.planning/phases/04-arquitectura-split-limpieza/04-02-SUMMARY.md
@apps/api/src/server.js
@apps/admin/src/main.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configurar CORS en API para subdominios</name>
  <files>
    apps/api/src/server.js
  </files>
  <action>
    Editar `apps/api/src/server.js` para configurar CORS din√°mico que permita requests de los subdominios.
    
    1. Buscar la configuraci√≥n actual de CORS (probablemente `app.use(cors())` o similar).
    
    2. Reemplazar con configuraci√≥n espec√≠fica para subdominios:
    
    ```javascript
    const cors = require('cors');
    
    // Or√≠genes permitidos seg√∫n ambiente
    const allowedOrigins = process.env.NODE_ENV === 'production'
      ? [
          'https://lapancomido.cl',
          'https://www.lapancomido.cl',
          'https://admin.lapancomido.cl'
        ]
      : [
          'http://localhost:3001',  // web dev
          'http://localhost:3002',  // admin dev
          'http://localhost:5173',  // vite default
          'http://127.0.0.1:3001',
          'http://127.0.0.1:3002',
          'http://127.0.0.1:5173'
        ];
    
    app.use(cors({
      origin: function(origin, callback) {
        // Permitir requests sin origin (como curl, Postman, mobile apps)
        if (!origin) return callback(null, true);
        
        if (allowedOrigins.includes(origin)) {
          callback(null, true);
        } else {
          console.warn(`CORS blocked request from: ${origin}`);
          callback(new Error('Not allowed by CORS'));
        }
      },
      credentials: true,
      methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
      allowedHeaders: ['Content-Type', 'Authorization']
    }));
    ```
    
    IMPORTANTE: Asegurarse de que esta configuraci√≥n est√© ANTES de las rutas.
  </action>
  <verify>
    ```bash
    grep -A5 "allowedOrigins" apps/api/src/server.js && echo "OK: CORS configured"
    ```
  </verify>
  <done>
    CORS configurado para permitir lapancomido.cl, admin.lapancomido.cl en producci√≥n y localhost en desarrollo.
  </done>
</task>

<task type="auto">
  <name>Task 2: Crear configuraciones Vercel para cada app</name>
  <files>
    apps/web/vercel.json
    apps/admin/vercel.json
    apps/api/vercel.json
  </files>
  <action>
    1. Crear/actualizar `apps/web/vercel.json` para el sitio p√∫blico:
    
    ```json
    {
      "framework": "vite",
      "buildCommand": "cd ../.. && npm run build --workspace=apps/web",
      "outputDirectory": "dist",
      "installCommand": "cd ../.. && npm install",
      "rewrites": [
        { "source": "/(.*)", "destination": "/index.html" }
      ]
    }
    ```
    
    2. Crear `apps/admin/vercel.json` para el panel admin:
    
    ```json
    {
      "framework": "vite",
      "buildCommand": "cd ../.. && npm run build --workspace=apps/admin",
      "outputDirectory": "dist",
      "installCommand": "cd ../.. && npm install",
      "rewrites": [
        { "source": "/(.*)", "destination": "/index.html" }
      ]
    }
    ```
    
    3. Crear `apps/api/vercel.json` para la API (Serverless Functions):
    
    ```json
    {
      "version": 2,
      "builds": [
        {
          "src": "src/server.js",
          "use": "@vercel/node"
        }
      ],
      "routes": [
        {
          "src": "/(.*)",
          "dest": "src/server.js"
        }
      ]
    }
    ```
    
    4. Eliminar el vercel.json antiguo de la ra√≠z si existe (la arquitectura ahora es split):
    ```bash
    rm vercel.json 2>/dev/null || true
    ```
  </action>
  <verify>
    ```bash
    cat apps/web/vercel.json | grep "vite" && echo "OK: web config"
    cat apps/admin/vercel.json | grep "vite" && echo "OK: admin config"
    cat apps/api/vercel.json | grep "vercel/node" && echo "OK: api config"
    ```
  </verify>
  <done>
    3 archivos vercel.json creados, uno para cada app con configuraci√≥n apropiada.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mejorar shell de admin y configurar env vars</name>
  <files>
    apps/admin/src/main.jsx
    apps/admin/index.html
    apps/web/src/helpers/api.jsx
  </files>
  <action>
    1. Mejorar `apps/admin/index.html` con t√≠tulo correcto:
    
    ```html
    <!DOCTYPE html>
    <html lang="es">
      <head>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/vite.svg" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin | La Pan Comido</title>
      </head>
      <body>
        <div id="root"></div>
        <script type="module" src="/src/main.jsx"></script>
      </body>
    </html>
    ```
    
    2. Mejorar `apps/admin/src/main.jsx` con mejor placeholder:
    
    ```jsx
    import ReactDOM from "react-dom/client";

    function App() {
      return (
        <div style={{ 
          minHeight: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: 'system-ui, sans-serif',
          backgroundColor: '#F5E1A4',
          color: '#262011'
        }}>
          <h1 style={{ fontSize: '2.5rem', marginBottom: '1rem' }}>
            ü•ñ La Pan Comido
          </h1>
          <h2 style={{ fontSize: '1.5rem', fontWeight: 'normal', marginBottom: '2rem' }}>
            Panel de Administraci√≥n
          </h2>
          <p style={{ 
            padding: '1rem 2rem',
            backgroundColor: 'rgba(38, 32, 17, 0.1)',
            borderRadius: '8px'
          }}>
            Pr√≥ximamente disponible ‚Äî Phase 5-6
          </p>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    ```
    
    3. Verificar/actualizar `apps/web/src/helpers/api.jsx` para usar variable de entorno para API URL:
    
    Buscar c√≥mo se configura la URL base de la API. Si est√° hardcodeada, cambiar a:
    ```javascript
    const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';
    ```
    
    4. Crear `.env.example` en apps/web si no existe, con las variables necesarias:
    ```
    VITE_API_URL=http://localhost:3000
    ```
    
    5. Crear `.env.example` en apps/admin:
    ```
    VITE_API_URL=http://localhost:3000
    ```
  </action>
  <verify>
    ```bash
    grep "La Pan Comido" apps/admin/index.html && echo "OK: admin html updated"
    grep "Pr√≥ximamente" apps/admin/src/main.jsx && echo "OK: admin placeholder"
    npm run --prefix apps/admin build && echo "OK: admin builds"
    ```
  </verify>
  <done>
    - Admin shell con branding correcto
    - Configuraci√≥n de env vars para API URL
    - Admin app construye correctamente
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Configuraci√≥n completa de subdominios:
    - CORS en API para lapancomido.cl y admin.lapancomido.cl
    - vercel.json para cada app (web, admin, api)
    - Shell de admin con placeholder
    - Variables de entorno para API URL
  </what-built>
  <how-to-verify>
    **Verificaci√≥n local:**
    1. Ejecutar API: `npm run --prefix apps/api dev`
    2. Ejecutar web: `npm run --prefix apps/web dev`
    3. Verificar que el cat√°logo funciona en http://localhost:3001
    
    **Deploy a Vercel (requiere configuraci√≥n manual):**
    
    El usuario debe:
    1. Crear proyecto Vercel para `apps/api` ‚Üí Asignar dominio `api.lapancomido.cl`
    2. Crear proyecto Vercel para `apps/admin` ‚Üí Asignar dominio `admin.lapancomido.cl`
    3. Actualizar proyecto existente de `apps/web` ‚Üí Verificar dominio `lapancomido.cl`
    4. En cada proyecto, configurar env vars:
       - DATABASE_URL (copiar del proyecto actual)
       - DIRECT_URL (copiar del proyecto actual)
       - VITE_API_URL=https://api.lapancomido.cl (para web y admin)
    
    **Verificar post-deploy:**
    1. https://lapancomido.cl carga el cat√°logo
    2. https://admin.lapancomido.cl muestra placeholder "Pr√≥ximamente disponible"
    3. https://api.lapancomido.cl/api/test responde JSON
    4. El cat√°logo puede cargar productos (CORS funciona)
  </how-to-verify>
  <resume-signal>
    Escribir "verified" cuando los 3 subdominios est√©n funcionando, o describir cualquier problema encontrado.
  </resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completa sin errores para todo el monorepo
2. `apps/api/vercel.json` existe y usa @vercel/node
3. `apps/admin/vercel.json` existe y usa Vite
4. `apps/web/vercel.json` existe y usa Vite
5. CORS en server.js permite subdominios de producci√≥n
6. Admin shell se renderiza con placeholder correcto
</verification>

<success_criteria>
- Los 3 subdominios responden correctamente:
  - lapancomido.cl ‚Üí Cat√°logo p√∫blico
  - admin.lapancomido.cl ‚Üí Placeholder admin
  - api.lapancomido.cl ‚Üí API endpoints
- CORS permite requests entre subdominios
- Build local funciona para las 3 apps
</success_criteria>

<output>
After completion, create `.planning/phases/04-arquitectura-split-limpieza/04-03-SUMMARY.md`
</output>
