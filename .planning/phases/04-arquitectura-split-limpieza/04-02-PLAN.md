---
phase: 04-arquitectura-split-limpieza
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/routes.js
  - apps/api/src/routes/auth.routes.js
  - apps/api/src/routes/gateways.routes.js
  - apps/api/src/routes/order.routes.js
  - apps/api/src/routes/address.routes.js
  - apps/api/src/routes/favorites.routes.js
  - apps/api/src/routes/user.routes.js
  - apps/api/src/routes/location.routes.js
  - apps/api/src/controllers/auth.controller.js
  - apps/api/src/controllers/gateways.controller.js
  - apps/api/src/controllers/order.controller.js
  - apps/api/src/controllers/address.controller.js
  - apps/api/src/controllers/favorites.controller.js
  - apps/api/src/controllers/user.controller.js
  - apps/api/src/controllers/location.controller.js
  - apps/api/src/models/Favorites.js
  - apps/api/src/models/Address.js
  - apps/api/src/models/User.js
  - apps/api/src/models/Auth.js
  - apps/api/src/services/paymentService.js
  - packages/database/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "API arranca sin errores con npm run dev"
    - "Endpoints activos funcionan (/products, /categories, /store, /contact)"
    - "Schema Prisma solo contiene modelos necesarios"
    - "No existen rutas de auth/orders/address/favorites/gateways/location"
  artifacts:
    - path: "apps/api/src/routes/routes.js"
      provides: "Solo rutas usadas: products, categories, admin, productImages, upload, store, contact"
    - path: "packages/database/prisma/schema.prisma"
      provides: "Solo modelos: products, product_img, categories, categories_products, stock, store_config, quotation_leads"
  key_links:
    - from: "apps/api/src/routes/routes.js"
      to: "apps/api/src/controllers/*"
      via: "require"
      pattern: "Solo controladores activos"
---

<objective>
Eliminar rutas, controladores, modelos y tablas de base de datos del sistema legacy de e-commerce (auth clientes, órdenes, direcciones, favoritos, pasarelas de pago).

Purpose: Limpiar la API de endpoints no utilizados y preparar el schema Prisma para la nueva arquitectura de admin auth en Phase 5.
Output: API limpia con solo endpoints activos, schema Prisma sin modelos legacy.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-arquitectura-split-limpieza/04-CONTEXT.md
@apps/api/src/routes/routes.js
@packages/database/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Eliminar rutas y controladores legacy de API</name>
  <files>
    apps/api/src/routes/routes.js
    apps/api/src/routes/auth.routes.js
    apps/api/src/routes/gateways.routes.js
    apps/api/src/routes/order.routes.js
    apps/api/src/routes/address.routes.js
    apps/api/src/routes/favorites.routes.js
    apps/api/src/routes/user.routes.js
    apps/api/src/routes/location.routes.js
    apps/api/src/controllers/auth.controller.js
    apps/api/src/controllers/gateways.controller.js
    apps/api/src/controllers/order.controller.js
    apps/api/src/controllers/address.controller.js
    apps/api/src/controllers/favorites.controller.js
    apps/api/src/controllers/user.controller.js
    apps/api/src/controllers/location.controller.js
    apps/api/src/models/Favorites.js
    apps/api/src/models/Address.js
    apps/api/src/models/User.js
    apps/api/src/models/Auth.js
    apps/api/src/services/paymentService.js
  </files>
  <action>
    1. Eliminar archivos de rutas no usadas:
    ```bash
    rm apps/api/src/routes/auth.routes.js
    rm apps/api/src/routes/gateways.routes.js
    rm apps/api/src/routes/order.routes.js
    rm apps/api/src/routes/address.routes.js
    rm apps/api/src/routes/favorites.routes.js
    rm apps/api/src/routes/user.routes.js
    rm apps/api/src/routes/location.routes.js
    ```
    
    2. Eliminar controladores no usados:
    ```bash
    rm apps/api/src/controllers/auth.controller.js
    rm apps/api/src/controllers/gateways.controller.js
    rm apps/api/src/controllers/order.controller.js
    rm apps/api/src/controllers/address.controller.js
    rm apps/api/src/controllers/favorites.controller.js
    rm apps/api/src/controllers/user.controller.js
    rm apps/api/src/controllers/location.controller.js
    ```
    
    3. Eliminar modelos legacy (SQL raw, no Prisma):
    ```bash
    rm apps/api/src/models/Favorites.js
    rm apps/api/src/models/Address.js
    rm apps/api/src/models/User.js
    rm apps/api/src/models/Auth.js
    ```
    
    4. Eliminar servicio de pagos:
    ```bash
    rm apps/api/src/services/paymentService.js
    ```
    
    5. Actualizar `routes.js` para quitar los requires e imports de rutas eliminadas:
    
    El archivo debe quedar así:
    ```javascript
    const express = require('express');
    const router = express.Router();

    const productRoutes = require('./product.routes');
    const adminRoutes = require('./admin.routes');
    const productImagesRoutes = require('./productImages.routes');
    const uploadRoute = require('./uploadRoute');
    const categoriesRoutes = require('./categories.routes');
    const storeRoutes = require('./store.routes');
    const contactRoutes = require('./contact.routes');

    router.use('/products', productRoutes);
    router.use('/admin', adminRoutes);
    router.use('/product-images', productImagesRoutes);
    router.use('/upload', uploadRoute);
    router.use('/categories', categoriesRoutes);
    router.use('/store', storeRoutes);
    router.use('/contact', contactRoutes);

    router.get('/test', (req, res) => res.json({ message: 'API funcionando' }));

    module.exports = router;
    ```
  </action>
  <verify>
    ```bash
    # Verificar que archivos fueron eliminados
    ls apps/api/src/routes/auth.routes.js 2>/dev/null && echo "FAIL" || echo "OK: deleted"
    ls apps/api/src/controllers/auth.controller.js 2>/dev/null && echo "FAIL" || echo "OK: deleted"
    ls apps/api/src/models/User.js 2>/dev/null && echo "FAIL" || echo "OK: deleted"
    
    # Verificar routes.js no tiene referencias rotas
    grep -E "authRoutes|gatewaysRoutes|orderRoutes|addressRoutes|favoritesRoutes|userRoutes|locationRoutes" apps/api/src/routes/routes.js && echo "FAIL: still has old imports" || echo "OK: clean"
    ```
  </verify>
  <done>
    - 7 archivos de rutas eliminados
    - 7 archivos de controladores eliminados  
    - 4 archivos de modelos eliminados
    - 1 servicio de pagos eliminado
    - routes.js actualizado sin referencias rotas
  </done>
</task>

<task type="auto">
  <name>Task 2: Limpiar schema Prisma y sincronizar con DB</name>
  <files>
    packages/database/prisma/schema.prisma
  </files>
  <action>
    1. Editar `packages/database/prisma/schema.prisma` para eliminar modelos legacy:
    
    **Eliminar completamente estos modelos:**
    - `users` (se recrea en Phase 5 con schema diferente para admin)
    - `roles` (relacionado con users)
    - `favorites` (funcionalidad de clientes eliminada)
    - `address` (direcciones de clientes)
    - `cities` (relacionado con address)
    - `provinces` (relacionado con cities)
    - `regions` (relacionado con provinces)
    
    **Actualizar modelo products** para quitar relación con favorites:
    Quitar línea: `favorites          favorites[]`
    
    El schema final debe contener SOLO:
    - `products` (sin relación favorites)
    - `product_img`
    - `categories`
    - `categories_products`
    - `stock`
    - `store_config`
    - `quotation_leads`
    
    2. Generar nuevo cliente Prisma:
    ```bash
    cd packages/database && npx prisma generate
    ```
    
    3. Sincronizar schema con DB (eliminar tablas obsoletas):
    ```bash
    cd packages/database && npx prisma db push --accept-data-loss
    ```
    
    NOTA: `--accept-data-loss` es seguro aquí porque:
    - La BD de Supabase es nueva (no hay data legacy)
    - Las tablas a eliminar están vacías
    - El contexto de Phase 4 confirma: "no hay data legacy que proteger"
  </action>
  <verify>
    ```bash
    # Verificar que modelos legacy no existen en schema
    grep -E "^model (users|roles|favorites|address|cities|provinces|regions)" packages/database/prisma/schema.prisma && echo "FAIL: legacy models still exist" || echo "OK: schema clean"
    
    # Verificar cliente Prisma generado
    ls packages/database/src/generated/client/index.js && echo "OK: client generated"
    ```
  </verify>
  <done>
    - 7 modelos legacy eliminados del schema
    - Cliente Prisma regenerado
    - BD sincronizada sin tablas obsoletas
  </done>
</task>

<task type="auto">
  <name>Task 3: Verificar API funciona y tests pasan</name>
  <files>
    apps/api/src/server.js
  </files>
  <action>
    1. Verificar que la API arranca sin errores:
    ```bash
    cd apps/api && timeout 10 npm run dev || true
    ```
    (El timeout es para verificar que arranca, luego se cierra)
    
    2. Verificar que no hay imports rotos en toda la API:
    ```bash
    grep -r "require.*auth\|require.*order\|require.*address\|require.*favorites\|require.*gateways\|require.*location\|require.*user\.routes\|require.*User\|require.*Auth\|require.*Address\|require.*Favorites" apps/api/src/ --include="*.js" | grep -v "node_modules" || echo "OK: no broken imports"
    ```
    
    3. Ejecutar build de turbo para verificar todo el monorepo:
    ```bash
    npm run build
    ```
    
    4. Si hay errores de lint en API por imports no usados, corregirlos.
  </action>
  <verify>
    ```bash
    # Build del monorepo debe completar sin errores
    npm run build 2>&1 | tail -5
    ```
  </verify>
  <done>
    - API arranca sin errores
    - No hay imports rotos
    - Build del monorepo completo exitoso
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completa sin errores para todo el monorepo
2. API responde en `/api/test` con mensaje de éxito
3. Endpoints activos funcionan: `/products`, `/categories`, `/store`
4. Schema Prisma solo tiene 7 modelos (products, product_img, categories, categories_products, stock, store_config, quotation_leads)
5. No existen archivos de rutas/controladores/modelos eliminados
</verification>

<success_criteria>
- Build del monorepo exitoso
- API arranca sin errores
- Endpoints del catálogo funcionan (/products, /categories)
- Schema Prisma limpio sin modelos legacy
- Sin archivos legacy de auth/orders/address/favorites en la API
</success_criteria>

<output>
After completion, create `.planning/phases/04-arquitectura-split-limpieza/04-02-SUMMARY.md`
</output>
