---
phase: 05-autenticacion-otp
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/api/src/middlewares/isDeveloper.js
  - apps/api/src/routes/admin.routes.js
  - apps/admin/src/pages/LoginPage.jsx
  - apps/admin/src/context/AuthContext.jsx
  - apps/admin/src/hooks/useAuth.js
  - apps/admin/src/App.jsx
  - apps/admin/src/api/auth.js
autonomous: false

must_haves:
  truths:
    - "Dispositivo confiable mantiene sesión por 30 días sin pedir OTP"
    - "Rol dev tiene acceso completo incluyendo feature toggles"
    - "Rol admin tiene acceso solo a gestión de contenido"
    - "Admin puede ver pantalla de login funcional"
  artifacts:
    - path: "apps/api/src/middlewares/isDeveloper.js"
      provides: "Middleware que solo permite rol developer"
      exports: ["isDeveloper"]
    - path: "apps/admin/src/pages/LoginPage.jsx"
      provides: "Página de login con flujo completo"
      min_lines: 100
    - path: "apps/admin/src/context/AuthContext.jsx"
      provides: "Context de autenticación con token y deviceToken"
      exports: ["AuthProvider", "useAuth"]
  key_links:
    - from: "apps/admin/src/pages/LoginPage.jsx"
      to: "apps/admin/src/api/auth.js"
      via: "API calls to login, setupPassword, verifyOTP"
      pattern: "authApi\\.(login|setupPassword|verifyOTP)"
    - from: "apps/admin/src/context/AuthContext.jsx"
      to: "localStorage"
      via: "deviceToken storage"
      pattern: "localStorage\\.(getItem|setItem).*deviceToken"
    - from: "apps/api/src/routes/admin.routes.js"
      to: "apps/api/src/middlewares/isDeveloper.js"
      via: "middleware chain"
      pattern: "isDeveloper"
---

<objective>
Implementar middleware de roles y pantalla de login en el admin panel

Purpose: Completar la autenticación con middleware que diferencia entre roles (dev vs admin), y crear la interfaz de login en apps/admin que maneje el flujo completo: login → setup password → OTP verification → dashboard.

Output:
- Middleware isDeveloper.js para rutas solo-developer
- Admin routes actualizadas con middleware de roles
- LoginPage.jsx con formularios de login, setup y OTP
- AuthContext para manejo de sesión en el frontend
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-autenticacion-otp/05-RESEARCH.md
@.planning/phases/05-autenticacion-otp/05-01-SUMMARY.md
@.planning/phases/05-autenticacion-otp/05-02-SUMMARY.md
@apps/api/src/middlewares/isAdmin.js
@apps/api/src/routes/admin.routes.js
@apps/admin/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crear middleware isDeveloper y actualizar admin routes</name>
  <files>
    apps/api/src/middlewares/isDeveloper.js
    apps/api/src/routes/admin.routes.js
  </files>
  <action>
**Crear apps/api/src/middlewares/isDeveloper.js:**

```javascript
// src/middlewares/isDeveloper.js
/**
 * Middleware that only allows users with role "developer"
 * Used for feature toggles and developer-only functionality
 */
const isDeveloper = (req, res, next) => {
  if (!req.user || !req.user.role) {
    return res.status(403).json({ 
      error: "Acceso denegado: rol no especificado." 
    });
  }
  
  if (req.user.role !== "developer") {
    return res.status(403).json({ 
      error: "Acceso denegado: requiere rol developer." 
    });
  }
  
  next();
};

module.exports = isDeveloper;
```

**Actualizar apps/api/src/routes/admin.routes.js** para usar middleware de roles:

Leer el archivo actual y agregar:
1. Import de isDeveloper al inicio
2. Comentario explicando qué rutas son admin vs developer
3. Preparar para futuras rutas developer-only (feature toggles)

```javascript
// Al inicio del archivo, agregar import:
const isDeveloper = require('../middlewares/isDeveloper');

// Agregar comentario de documentación antes de las rutas:
/*
 * Admin Routes - Protected by validateToken + isAdmin
 * 
 * Roles:
 * - "admin": Can manage products, categories, content
 * - "developer": Full access including feature toggles
 * 
 * Future developer-only routes:
 * - POST /admin/feature-toggles - Update feature flags
 * - GET /admin/system-info - View system diagnostics
 */
```

Las rutas existentes ya usan isAdmin que permite ambos roles (admin y developer).
  </action>
  <verify>
```bash
# Verify isDeveloper middleware exists
cat apps/api/src/middlewares/isDeveloper.js | head -20

# Verify import in admin routes
grep -E "(isDeveloper|require.*isDeveloper)" apps/api/src/routes/admin.routes.js
```
Debe mostrar el middleware y su import en admin.routes.js.
  </verify>
  <done>
- isDeveloper.js middleware creado y exportado
- admin.routes.js importa isDeveloper y está preparado para rutas developer-only
- Documentación clara de roles en el archivo de rutas
  </done>
</task>

<task type="auto">
  <name>Task 2: Crear sistema de autenticación en admin frontend</name>
  <files>
    apps/admin/src/api/auth.js
    apps/admin/src/context/AuthContext.jsx
    apps/admin/src/hooks/useAuth.js
    apps/admin/src/pages/LoginPage.jsx
    apps/admin/src/App.jsx
  </files>
  <action>
**Crear apps/admin/src/api/auth.js:**

```javascript
// src/api/auth.js
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';

/**
 * Login with username and password
 */
export async function login(username, password, deviceToken = null) {
  const response = await fetch(`${API_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password, deviceToken })
  });
  return response.json();
}

/**
 * First-time password setup
 */
export async function setupPassword(username, email, password) {
  const response = await fetch(`${API_URL}/auth/setup-password`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, password })
  });
  return response.json();
}

/**
 * Verify OTP code
 */
export async function verifyOTP(otpPendingToken, otp) {
  const response = await fetch(`${API_URL}/auth/verify-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ otpPendingToken, otp })
  });
  return response.json();
}

/**
 * Resend OTP code
 */
export async function resendOTP(otpPendingToken) {
  const response = await fetch(`${API_URL}/auth/resend-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ otpPendingToken })
  });
  return response.json();
}

export default { login, setupPassword, verifyOTP, resendOTP };
```

**Crear apps/admin/src/context/AuthContext.jsx:**

```jsx
// src/context/AuthContext.jsx
import { createContext, useContext, useState, useEffect } from 'react';

const AuthContext = createContext(null);

const TOKEN_KEY = 'admin_token';
const DEVICE_TOKEN_KEY = 'admin_device_token';

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [loading, setLoading] = useState(true);

  // Load token from localStorage on mount
  useEffect(() => {
    const storedToken = localStorage.getItem(TOKEN_KEY);
    if (storedToken) {
      try {
        // Decode JWT to get user info (without verification - server will verify)
        const payload = JSON.parse(atob(storedToken.split('.')[1]));
        
        // Check if token is expired
        if (payload.exp * 1000 > Date.now()) {
          setToken(storedToken);
          setUser({
            id: payload.userId,
            username: payload.username,
            email: payload.email,
            role: payload.role
          });
        } else {
          // Token expired, clear it
          localStorage.removeItem(TOKEN_KEY);
        }
      } catch (e) {
        console.error('Invalid token:', e);
        localStorage.removeItem(TOKEN_KEY);
      }
    }
    setLoading(false);
  }, []);

  const getDeviceToken = () => {
    return localStorage.getItem(DEVICE_TOKEN_KEY);
  };

  const saveAuth = (authToken, deviceToken, userData) => {
    localStorage.setItem(TOKEN_KEY, authToken);
    if (deviceToken) {
      localStorage.setItem(DEVICE_TOKEN_KEY, deviceToken);
    }
    setToken(authToken);
    setUser(userData);
  };

  const logout = () => {
    localStorage.removeItem(TOKEN_KEY);
    // Note: We keep deviceToken so next login doesn't require OTP
    setToken(null);
    setUser(null);
  };

  const value = {
    user,
    token,
    loading,
    isAuthenticated: !!token,
    isDeveloper: user?.role === 'developer',
    isAdmin: user?.role === 'admin' || user?.role === 'developer',
    getDeviceToken,
    saveAuth,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

export default AuthContext;
```

**Crear apps/admin/src/pages/LoginPage.jsx:**

```jsx
// src/pages/LoginPage.jsx
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import * as authApi from '../api/auth';

export default function LoginPage() {
  const { saveAuth, getDeviceToken } = useAuth();
  
  // Form state
  const [step, setStep] = useState('login'); // 'login' | 'setup' | 'otp'
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');
  const [otpPendingToken, setOtpPendingToken] = useState(null);
  const [maskedEmail, setMaskedEmail] = useState('');
  
  // UI state
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const deviceToken = getDeviceToken();
      const result = await authApi.login(username, password, deviceToken);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      if (result.setupRequired) {
        // First-time login - need to set up password
        setStep('setup');
        setSuccess(result.message);
        return;
      }
      
      if (result.otpRequired) {
        // New device - need OTP verification
        setOtpPendingToken(result.otpPendingToken);
        setMaskedEmail(result.email);
        setStep('otp');
        setSuccess(result.message);
        return;
      }
      
      if (result.success) {
        // Trusted device - direct login
        saveAuth(result.token, null, result.user);
      }
    } catch (err) {
      console.error('Login error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleSetup = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.setupPassword(username, email, password);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      if (result.success) {
        saveAuth(result.token, result.deviceToken, result.user);
      }
    } catch (err) {
      console.error('Setup error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleVerifyOTP = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.verifyOTP(otpPendingToken, otp);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      if (result.success) {
        saveAuth(result.token, result.deviceToken, result.user);
      }
    } catch (err) {
      console.error('OTP verification error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleResendOTP = async () => {
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.resendOTP(otpPendingToken);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      setSuccess(result.message);
    } catch (err) {
      console.error('Resend OTP error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-[#FDF8E8] p-4">
      <div className="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
        {/* Logo/Header */}
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-[#262011]">
            La Pan Comido
          </h1>
          <p className="text-[#262011]/60 mt-1">Panel de Administración</p>
        </div>

        {/* Error/Success Messages */}
        {error && (
          <div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm">
            {error}
          </div>
        )}
        {success && !error && (
          <div className="mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded-lg text-sm">
            {success}
          </div>
        )}

        {/* Login Form */}
        {step === 'login' && (
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">
                Usuario
              </label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-base"
                placeholder="dev o admin"
                required
                disabled={loading}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">
                Contraseña
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-base"
                placeholder="Tu contraseña"
                disabled={loading}
              />
              <p className="text-xs text-gray-500 mt-1">
                Deja vacío si es tu primer inicio de sesión
              </p>
            </div>
            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-[#262011] text-[#F5E1A4] rounded-lg font-medium hover:bg-[#262011]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {loading ? 'Iniciando sesión...' : 'Iniciar Sesión'}
            </button>
          </form>
        )}

        {/* Setup Password Form */}
        {step === 'setup' && (
          <form onSubmit={handleSetup} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-4">
              Configura tu email y contraseña para continuar.
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">
                Email
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-base"
                placeholder="tu@email.com"
                required
                disabled={loading}
              />
              <p className="text-xs text-gray-500 mt-1">
                Se usará para enviar códigos de verificación
              </p>
            </div>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">
                Nueva Contraseña
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-base"
                placeholder="Mínimo 8 caracteres"
                required
                minLength={8}
                disabled={loading}
              />
            </div>
            <button
              type="submit"
              disabled={loading}
              className="w-full py-3 bg-[#262011] text-[#F5E1A4] rounded-lg font-medium hover:bg-[#262011]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {loading ? 'Configurando...' : 'Configurar y Continuar'}
            </button>
            <button
              type="button"
              onClick={() => { setStep('login'); setError(''); setSuccess(''); }}
              className="w-full py-2 text-[#262011]/70 hover:text-[#262011] text-sm"
              disabled={loading}
            >
              ← Volver al inicio
            </button>
          </form>
        )}

        {/* OTP Verification Form */}
        {step === 'otp' && (
          <form onSubmit={handleVerifyOTP} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-4">
              Enviamos un código de verificación a <strong>{maskedEmail}</strong>
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">
                Código de Verificación
              </label>
              <input
                type="text"
                value={otp}
                onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-center text-2xl tracking-widest font-mono"
                placeholder="000000"
                maxLength={6}
                required
                disabled={loading}
              />
            </div>
            <button
              type="submit"
              disabled={loading || otp.length !== 6}
              className="w-full py-3 bg-[#262011] text-[#F5E1A4] rounded-lg font-medium hover:bg-[#262011]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {loading ? 'Verificando...' : 'Verificar Código'}
            </button>
            <div className="flex items-center justify-between text-sm">
              <button
                type="button"
                onClick={handleResendOTP}
                className="text-[#262011]/70 hover:text-[#262011]"
                disabled={loading}
              >
                Reenviar código
              </button>
              <button
                type="button"
                onClick={() => { setStep('login'); setError(''); setSuccess(''); setOtp(''); }}
                className="text-[#262011]/70 hover:text-[#262011]"
                disabled={loading}
              >
                ← Volver al inicio
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
```

**Actualizar apps/admin/src/App.jsx** para usar AuthContext y mostrar LoginPage:

```jsx
// src/App.jsx
import { AuthProvider, useAuth } from './context/AuthContext';
import LoginPage from './pages/LoginPage';

function AdminContent() {
  const { isAuthenticated, loading, user, logout, isDeveloper } = useAuth();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#FDF8E8]">
        <div className="text-[#262011]">Cargando...</div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return <LoginPage />;
  }

  // Authenticated - show dashboard
  return (
    <div className="min-h-screen bg-[#FDF8E8]">
      <header className="bg-[#262011] text-[#F5E1A4] p-4">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <h1 className="text-xl font-bold">La Pan Comido - Admin</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm">
              {user?.username} 
              <span className="opacity-60 ml-1">
                ({isDeveloper ? 'Developer' : 'Admin'})
              </span>
            </span>
            <button
              onClick={logout}
              className="px-3 py-1 bg-[#F5E1A4] text-[#262011] rounded text-sm font-medium hover:bg-[#F5E1A4]/90"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto p-6">
        <div className="bg-white rounded-xl shadow-sm p-8 text-center">
          <h2 className="text-2xl font-bold text-[#262011] mb-2">
            ¡Bienvenido, {user?.username}!
          </h2>
          <p className="text-[#262011]/60">
            El panel de administración estará disponible en la siguiente fase.
          </p>
          {isDeveloper && (
            <div className="mt-4 p-3 bg-blue-50 rounded-lg text-blue-700 text-sm">
              Tienes acceso de desarrollador. Podrás ver feature toggles y diagnósticos del sistema.
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

function App() {
  return (
    <AuthProvider>
      <AdminContent />
    </AuthProvider>
  );
}

export default App;
```
  </action>
  <verify>
```bash
# Verify all files were created
ls -la apps/admin/src/api/auth.js apps/admin/src/context/AuthContext.jsx apps/admin/src/pages/LoginPage.jsx

# Verify exports
grep -E "export (function|default|const)" apps/admin/src/api/auth.js

# Verify App.jsx uses AuthProvider
grep -E "(AuthProvider|LoginPage)" apps/admin/src/App.jsx
```
Debe mostrar los archivos creados, las funciones exportadas, y que App.jsx usa AuthProvider.
  </verify>
  <done>
- api/auth.js con funciones login, setupPassword, verifyOTP, resendOTP
- AuthContext.jsx con manejo de token y deviceToken
- LoginPage.jsx con formularios para los 3 pasos (login, setup, otp)
- App.jsx integrado con AuthProvider y condicional de login
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verificar flujo completo de autenticación</name>
  <what-built>Sistema completo de autenticación OTP con UI de login</what-built>
  <how-to-verify>
1. Iniciar API y Admin:
   ```bash
   npm run dev
   ```
   
2. Abrir http://localhost:3002 (admin)

3. **Test 1 - Setup inicial:**
   - Ingresar username "dev" (sin password)
   - Debe mostrar formulario de setup (email + password)
   - Completar con email real y password (mín 8 chars)
   - Debe loguearte y mostrar dashboard

4. **Test 2 - Login dispositivo confiable:**
   - Hacer logout
   - Login con "dev" + password configurado
   - Debe entrar directo (mismo dispositivo = confiable)

5. **Test 3 - Nuevo dispositivo (simular):**
   - Abrir consola del navegador
   - Ejecutar: `localStorage.removeItem('admin_device_token')`
   - Hacer logout y login de nuevo
   - Debe pedir OTP (si RESEND_API_KEY configurado)
   - Revisar email, ingresar código
   - Debe loguearte y crear nuevo device token

6. **Verificar roles:**
   - Con user "dev" debe mostrar "Developer" y badge azul
   - Header debe mostrar username y botón cerrar sesión
  </how-to-verify>
  <resume-signal>Type "approved" si todo funciona, o describe los issues encontrados</resume-signal>
</task>

</tasks>

<verification>
```bash
# Verify middleware
node -e "
const isDeveloper = require('./apps/api/src/middlewares/isDeveloper.js');
console.log('isDeveloper type:', typeof isDeveloper);
"

# Verify admin app builds
cd apps/admin && npm run build 2>&1 | tail -5

# Verify API routes registered
grep -E "(validateToken|isAdmin|isDeveloper)" apps/api/src/routes/admin.routes.js
```
</verification>

<success_criteria>
1. isDeveloper.js middleware existe y rechaza usuarios sin rol "developer"
2. admin.routes.js tiene imports de isAdmin e isDeveloper
3. LoginPage.jsx maneja 3 flujos: login básico, setup password, verificación OTP
4. AuthContext.jsx persiste token y deviceToken en localStorage
5. App.jsx muestra LoginPage cuando no autenticado, dashboard cuando sí
6. Sesión persiste 30 días en dispositivo confiable (no pide OTP)
</success_criteria>

<output>
After completion, create `.planning/phases/05-autenticacion-otp/05-03-SUMMARY.md`
</output>
