---
phase: 05-autenticacion-otp
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/api/src/middlewares/isDeveloper.js
  - apps/api/src/routes/admin.routes.js
  - apps/api/src/controllers/auth.controller.js
  - apps/admin/src/pages/LoginPage.jsx
  - apps/admin/src/pages/SettingsPage.jsx
  - apps/admin/src/context/AuthContext.jsx
  - apps/admin/src/api/auth.js
  - apps/admin/src/App.jsx
  - apps/admin/package.json
autonomous: false
user_setup:
  - service: cloudflare-turnstile
    why: "Captcha for login protection"
    env_vars:
      - name: VITE_TURNSTILE_SITE_KEY
        source: "Cloudflare Dashboard -> Turnstile -> Add Site -> Site Key"
      - name: TURNSTILE_SECRET_KEY
        source: "Cloudflare Dashboard -> Turnstile -> Add Site -> Secret Key"
    dashboard_config:
      - task: "Create Turnstile widget for admin.lapancomido.cl"
        location: "Cloudflare Dashboard -> Turnstile -> Add Site"

must_haves:
  truths:
    - "Login requiere Cloudflare Turnstile captcha"
    - "Checkbox explícito 'Confiar en este dispositivo por 30 días' después de OTP"
    - "Settings page tiene botón 'Cerrar todas las sesiones'"
    - "UI mobile-first con branding completo (#F5E1A4, #262011)"
    - "Errores inline bajo los campos en rojo"
  artifacts:
    - path: "apps/api/src/middlewares/isDeveloper.js"
      provides: "Middleware que solo permite rol developer"
      exports: ["isDeveloper"]
    - path: "apps/admin/src/pages/LoginPage.jsx"
      provides: "Página de login con Turnstile, flujo completo, y trust checkbox"
      min_lines: 200
    - path: "apps/admin/src/pages/SettingsPage.jsx"
      provides: "Página de configuración con cerrar todas las sesiones"
      min_lines: 50
    - path: "apps/admin/src/context/AuthContext.jsx"
      provides: "Context de autenticación con token management"
      exports: ["AuthProvider", "useAuth"]
  key_links:
    - from: "apps/admin/src/pages/LoginPage.jsx"
      to: "Turnstile"
      via: "@marsidev/react-turnstile component"
      pattern: "Turnstile"
    - from: "apps/admin/src/pages/LoginPage.jsx"
      to: "apps/admin/src/api/auth.js"
      via: "API calls"
      pattern: "authApi\\."
    - from: "apps/admin/src/pages/SettingsPage.jsx"
      to: "apps/admin/src/api/auth.js"
      via: "logoutAll call"
      pattern: "logoutAll"
---

<objective>
Implementar UI de login con Turnstile, flujo completo, y página de configuración

Purpose: Completar la autenticación con:
1. Turnstile captcha en login (protección contra bots)
2. UI mobile-first con branding La Pan Comido
3. Flujo completo: login → setup → OTP → trust checkbox → dashboard
4. Página de configuración con "Cerrar todas las sesiones"
5. Middleware isDeveloper para rutas developer-only

Output:
- isDeveloper.js middleware
- LoginPage.jsx con Turnstile y flujo multi-step
- SettingsPage.jsx con logout all devices
- AuthContext para manejo de sesión
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-autenticacion-otp/05-RESEARCH.md
@.planning/phases/05-autenticacion-otp/05-CONTEXT.md
@.planning/phases/05-autenticacion-otp/05-01-SUMMARY.md
@.planning/phases/05-autenticacion-otp/05-02-SUMMARY.md
@apps/api/src/middlewares/isAdmin.js
@apps/api/src/routes/admin.routes.js
@apps/admin/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crear middleware isDeveloper y verificación Turnstile en API</name>
  <files>
    apps/api/src/middlewares/isDeveloper.js
    apps/api/src/middlewares/verifyTurnstile.js
    apps/api/src/routes/admin.routes.js
    apps/api/src/routes/auth.routes.js
  </files>
  <action>
**Crear apps/api/src/middlewares/isDeveloper.js:**

```javascript
// src/middlewares/isDeveloper.js
/**
 * Middleware that only allows users with role "developer"
 * Used for feature toggles and developer-only functionality
 */
const isDeveloper = (req, res, next) => {
  if (!req.user || !req.user.role) {
    return res.status(403).json({ 
      error: "Acceso denegado: rol no especificado." 
    });
  }
  
  if (req.user.role !== "developer") {
    return res.status(403).json({ 
      error: "Acceso denegado: requiere rol developer." 
    });
  }
  
  next();
};

module.exports = isDeveloper;
```

**Crear apps/api/src/middlewares/verifyTurnstile.js:**

```javascript
// src/middlewares/verifyTurnstile.js
/**
 * Verify Cloudflare Turnstile token
 * Per CONTEXT.md: Use Turnstile captcha on login
 */
async function verifyTurnstile(req, res, next) {
  const token = req.body.turnstileToken;
  
  // Skip in development if no secret configured
  if (!process.env.TURNSTILE_SECRET_KEY) {
    console.warn('[DEV] Turnstile verification skipped - no secret key');
    return next();
  }
  
  if (!token) {
    return res.status(400).json({ 
      error: 'Verificación de seguridad requerida',
      turnstileRequired: true 
    });
  }
  
  try {
    const response = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        secret: process.env.TURNSTILE_SECRET_KEY,
        response: token,
        remoteip: req.ip
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      console.error('Turnstile verification failed:', result);
      return res.status(400).json({ 
        error: 'Verificación de seguridad fallida. Intenta de nuevo.',
        turnstileError: true
      });
    }
    
    next();
  } catch (error) {
    console.error('Turnstile API error:', error);
    // Allow through on API error to not block users
    next();
  }
}

module.exports = verifyTurnstile;
```

**Actualizar apps/api/src/routes/auth.routes.js** para usar Turnstile en login:

Agregar al inicio:
```javascript
const verifyTurnstile = require('../middlewares/verifyTurnstile');
```

Modificar la ruta de login para incluir Turnstile:
```javascript
router.post('/login', authLimiter, verifyTurnstile, authController.login);
```

**Actualizar apps/api/src/routes/admin.routes.js** para documentar roles:

Agregar al inicio:
```javascript
const isDeveloper = require('../middlewares/isDeveloper');
```

Agregar comentario de documentación:
```javascript
/*
 * Admin Routes - Protected by validateToken + isAdmin
 * 
 * Roles:
 * - "admin": Can manage products, categories, content
 * - "developer": Full access including feature toggles
 * 
 * Developer-only routes (future):
 * - POST /admin/feature-toggles - Update feature flags
 * - GET /admin/system-info - View system diagnostics
 */
```
  </action>
  <verify>
```bash
# Verify middlewares exist
ls apps/api/src/middlewares/isDeveloper.js apps/api/src/middlewares/verifyTurnstile.js

# Verify imports in routes
grep -E "(isDeveloper|verifyTurnstile)" apps/api/src/routes/*.js
```
Debe mostrar ambos middlewares y sus imports.
  </verify>
  <done>
- isDeveloper.js middleware para rutas developer-only
- verifyTurnstile.js middleware para validar Turnstile token
- auth.routes.js usa Turnstile en /login
- admin.routes.js documenta roles y importa isDeveloper
  </done>
</task>

<task type="auto">
  <name>Task 2: Crear sistema de autenticación en admin frontend</name>
  <files>
    apps/admin/src/api/auth.js
    apps/admin/src/context/AuthContext.jsx
    apps/admin/src/pages/LoginPage.jsx
    apps/admin/src/pages/SettingsPage.jsx
    apps/admin/src/App.jsx
    apps/admin/package.json
  </files>
  <action>
**Instalar Turnstile en apps/admin:**
```bash
cd apps/admin && npm install @marsidev/react-turnstile
```

**Crear apps/admin/src/api/auth.js:**

```javascript
// src/api/auth.js
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';

/**
 * Login with username, password, and Turnstile token
 */
export async function login(username, password, turnstileToken) {
  const response = await fetch(`${API_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include', // For cookies
    body: JSON.stringify({ username, password, turnstileToken })
  });
  return response.json();
}

/**
 * Initiate first-time setup (send OTP to email)
 */
export async function initiateSetup(username, email) {
  const response = await fetch(`${API_URL}/auth/initiate-setup`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ username, email })
  });
  return response.json();
}

/**
 * Verify OTP for email validation during setup
 */
export async function verifySetupOTP(setupToken, otp) {
  const response = await fetch(`${API_URL}/auth/verify-setup-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ setupToken, otp })
  });
  return response.json();
}

/**
 * Complete setup with new password
 */
export async function completeSetup(passwordSetupToken, password, confirmPassword) {
  const response = await fetch(`${API_URL}/auth/complete-setup`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ passwordSetupToken, password, confirmPassword })
  });
  return response.json();
}

/**
 * Verify OTP for login (new device)
 */
export async function verifyLoginOTP(otpPendingToken, otp, trustDevice) {
  const response = await fetch(`${API_URL}/auth/verify-login-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ otpPendingToken, otp, trustDevice })
  });
  return response.json();
}

/**
 * Resend OTP
 */
export async function resendOTP(otpPendingToken) {
  const response = await fetch(`${API_URL}/auth/resend-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ otpPendingToken })
  });
  return response.json();
}

/**
 * Logout all devices
 */
export async function logoutAll(token) {
  const response = await fetch(`${API_URL}/auth/logout-all`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    credentials: 'include'
  });
  return response.json();
}

export default { 
  login, 
  initiateSetup, 
  verifySetupOTP, 
  completeSetup, 
  verifyLoginOTP, 
  resendOTP, 
  logoutAll 
};
```

**Crear apps/admin/src/context/AuthContext.jsx:**

```jsx
// src/context/AuthContext.jsx
import { createContext, useContext, useState, useEffect } from 'react';

const AuthContext = createContext(null);
const TOKEN_KEY = 'admin_token';

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const storedToken = localStorage.getItem(TOKEN_KEY);
    if (storedToken) {
      try {
        const payload = JSON.parse(atob(storedToken.split('.')[1]));
        
        if (payload.exp * 1000 > Date.now()) {
          setToken(storedToken);
          setUser({
            id: payload.userId,
            username: payload.username,
            email: payload.email,
            role: payload.role
          });
        } else {
          localStorage.removeItem(TOKEN_KEY);
        }
      } catch (e) {
        console.error('Invalid token:', e);
        localStorage.removeItem(TOKEN_KEY);
      }
    }
    setLoading(false);
  }, []);

  const saveAuth = (authToken, userData) => {
    localStorage.setItem(TOKEN_KEY, authToken);
    setToken(authToken);
    setUser(userData);
  };

  const logout = () => {
    localStorage.removeItem(TOKEN_KEY);
    setToken(null);
    setUser(null);
  };

  const value = {
    user,
    token,
    loading,
    isAuthenticated: !!token,
    isDeveloper: user?.role === 'developer',
    isAdmin: user?.role === 'admin' || user?.role === 'developer',
    saveAuth,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

export default AuthContext;
```

**Crear apps/admin/src/pages/LoginPage.jsx:**

```jsx
// src/pages/LoginPage.jsx
import { useState, useRef, useEffect } from 'react';
import { Turnstile } from '@marsidev/react-turnstile';
import { useAuth } from '../context/AuthContext';
import * as authApi from '../api/auth';

const TURNSTILE_SITE_KEY = import.meta.env.VITE_TURNSTILE_SITE_KEY;

export default function LoginPage() {
  const { saveAuth } = useAuth();
  const turnstileRef = useRef(null);
  
  // Steps: 'login' | 'setup-email' | 'setup-otp' | 'setup-password' | 'login-otp'
  const [step, setStep] = useState('login');
  
  // Form state
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [trustDevice, setTrustDevice] = useState(true);
  const [turnstileToken, setTurnstileToken] = useState(null);
  
  // Tokens
  const [setupToken, setSetupToken] = useState(null);
  const [passwordSetupToken, setPasswordSetupToken] = useState(null);
  const [otpPendingToken, setOtpPendingToken] = useState(null);
  
  // UI state
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [maskedEmail, setMaskedEmail] = useState('');
  const [resendCooldown, setResendCooldown] = useState(0);
  
  // Resend cooldown timer
  useEffect(() => {
    if (resendCooldown > 0) {
      const timer = setTimeout(() => setResendCooldown(c => c - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [resendCooldown]);

  const resetTurnstile = () => {
    turnstileRef.current?.reset();
    setTurnstileToken(null);
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.login(username, password, turnstileToken);
      
      if (result.error) {
        setError(result.error);
        if (result.turnstileError || result.turnstileRequired) {
          resetTurnstile();
        }
        return;
      }
      
      if (result.setupRequired) {
        setStep('setup-email');
        setSuccess(result.message);
        return;
      }
      
      if (result.otpRequired) {
        setOtpPendingToken(result.otpPendingToken);
        setMaskedEmail(result.email);
        setStep('login-otp');
        setSuccess(result.message);
        return;
      }
      
      if (result.success) {
        saveAuth(result.token, result.user);
      }
    } catch (err) {
      console.error('Login error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleInitiateSetup = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.initiateSetup(username, email);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      setSetupToken(result.setupToken);
      setStep('setup-otp');
      setSuccess(result.message);
    } catch (err) {
      console.error('Setup error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleVerifySetupOTP = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.verifySetupOTP(setupToken, otp);
      
      if (result.error) {
        setError(result.error);
        if (result.hint) {
          setError(prev => `${prev}. ${result.hint}`);
        }
        return;
      }
      
      setPasswordSetupToken(result.passwordSetupToken);
      setOtp('');
      setStep('setup-password');
      setSuccess(result.message);
    } catch (err) {
      console.error('OTP error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleCompleteSetup = async (e) => {
    e.preventDefault();
    setError('');
    
    if (newPassword !== confirmPassword) {
      setError('Las contraseñas no coinciden');
      return;
    }
    
    setLoading(true);
    
    try {
      const result = await authApi.completeSetup(passwordSetupToken, newPassword, confirmPassword);
      
      if (result.error) {
        if (result.details) {
          setError(result.details.join('. '));
        } else {
          setError(result.error);
        }
        return;
      }
      
      // Per CONTEXT.md: return to login after setup
      setStep('login');
      setPassword('');
      setSuccess(result.message);
      resetTurnstile();
    } catch (err) {
      console.error('Complete setup error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleVerifyLoginOTP = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await authApi.verifyLoginOTP(otpPendingToken, otp, trustDevice);
      
      if (result.error) {
        setError(result.error);
        if (result.hint) {
          setError(prev => `${prev}. ${result.hint}`);
        }
        return;
      }
      
      saveAuth(result.token, result.user);
    } catch (err) {
      console.error('OTP error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const handleResendOTP = async () => {
    if (resendCooldown > 0) return;
    
    setError('');
    setLoading(true);
    
    try {
      const token = step === 'setup-otp' ? setupToken : otpPendingToken;
      const result = await authApi.resendOTP(token);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      if (step === 'setup-otp') {
        setSetupToken(result.otpPendingToken);
      } else {
        setOtpPendingToken(result.otpPendingToken);
      }
      
      setSuccess(result.message);
      setResendCooldown(result.nextResendIn || 30);
    } catch (err) {
      console.error('Resend error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  const goBack = () => {
    setError('');
    setSuccess('');
    setOtp('');
    
    if (step === 'setup-email' || step === 'login-otp') {
      setStep('login');
      resetTurnstile();
    } else if (step === 'setup-otp') {
      setStep('setup-email');
    } else if (step === 'setup-password') {
      setStep('setup-otp');
    }
  };

  // Render helper for inline errors
  const renderError = () => error && (
    <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
      {error}
    </div>
  );

  const renderSuccess = () => success && !error && (
    <div className="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm">
      {success}
    </div>
  );

  const inputClass = "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F5E1A4] focus:border-transparent outline-none text-base";
  const buttonClass = "w-full py-3 bg-[#262011] text-[#F5E1A4] rounded-lg font-medium hover:bg-[#262011]/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors min-h-[48px]";
  const linkButtonClass = "text-[#262011]/70 hover:text-[#262011] text-sm disabled:opacity-50";

  return (
    <div className="min-h-screen flex items-center justify-center bg-[#FDF8E8] p-4">
      <div className="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 sm:p-8">
        {/* Logo/Header */}
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-[#262011]">La Pan Comido</h1>
          <p className="text-[#262011]/60 mt-1 text-sm">Panel de Administración</p>
        </div>

        {renderError()}
        {renderSuccess()}

        {/* Login Form */}
        {step === 'login' && (
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Usuario</label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className={inputClass}
                placeholder="dev o admin"
                required
                disabled={loading}
                autoComplete="username"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Contraseña</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className={inputClass}
                placeholder="Tu contraseña"
                required
                disabled={loading}
                autoComplete="current-password"
              />
            </div>
            
            {/* Turnstile Captcha */}
            {TURNSTILE_SITE_KEY && (
              <div className="flex justify-center">
                <Turnstile
                  ref={turnstileRef}
                  siteKey={TURNSTILE_SITE_KEY}
                  onSuccess={setTurnstileToken}
                  onError={() => setError('Error de verificación. Recarga la página.')}
                />
              </div>
            )}
            
            <button type="submit" disabled={loading || (TURNSTILE_SITE_KEY && !turnstileToken)} className={buttonClass}>
              {loading ? 'Iniciando sesión...' : 'Iniciar Sesión'}
            </button>
          </form>
        )}

        {/* Setup Email Form */}
        {step === 'setup-email' && (
          <form onSubmit={handleInitiateSetup} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-2">
              Ingresa tu email para recibir el código de verificación.
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Email</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className={inputClass}
                placeholder="tu@email.com"
                required
                disabled={loading}
                autoComplete="email"
              />
            </div>
            <button type="submit" disabled={loading} className={buttonClass}>
              {loading ? 'Enviando...' : 'Enviar Código'}
            </button>
            <button type="button" onClick={goBack} className={`w-full ${linkButtonClass}`} disabled={loading}>
              ← Volver
            </button>
          </form>
        )}

        {/* Setup OTP Form */}
        {step === 'setup-otp' && (
          <form onSubmit={handleVerifySetupOTP} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-2">
              Ingresa el código de 8 dígitos enviado a tu email.
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Código</label>
              <input
                type="text"
                value={otp}
                onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 8))}
                className={`${inputClass} text-center text-2xl tracking-widest font-mono`}
                placeholder="00000000"
                maxLength={8}
                required
                disabled={loading}
                inputMode="numeric"
              />
            </div>
            <button type="submit" disabled={loading || otp.length !== 8} className={buttonClass}>
              {loading ? 'Verificando...' : 'Verificar'}
            </button>
            <div className="flex justify-between">
              <button type="button" onClick={handleResendOTP} disabled={loading || resendCooldown > 0} className={linkButtonClass}>
                {resendCooldown > 0 ? `Reenviar (${resendCooldown}s)` : 'Reenviar código'}
              </button>
              <button type="button" onClick={goBack} className={linkButtonClass} disabled={loading}>
                ← Volver
              </button>
            </div>
          </form>
        )}

        {/* Setup Password Form */}
        {step === 'setup-password' && (
          <form onSubmit={handleCompleteSetup} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-2">
              Crea una contraseña segura (8+ caracteres, mayúscula, minúscula, número, símbolo).
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Nueva Contraseña</label>
              <input
                type="password"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                className={inputClass}
                placeholder="••••••••"
                required
                disabled={loading}
                autoComplete="new-password"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Confirmar Contraseña</label>
              <input
                type="password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                className={inputClass}
                placeholder="••••••••"
                required
                disabled={loading}
                autoComplete="new-password"
              />
            </div>
            <button type="submit" disabled={loading} className={buttonClass}>
              {loading ? 'Guardando...' : 'Guardar y Continuar'}
            </button>
          </form>
        )}

        {/* Login OTP Form with Trust Checkbox */}
        {step === 'login-otp' && (
          <form onSubmit={handleVerifyLoginOTP} className="space-y-4">
            <p className="text-sm text-[#262011]/70 mb-2">
              Código enviado a <strong>{maskedEmail}</strong>
            </p>
            <div>
              <label className="block text-sm font-medium text-[#262011] mb-1">Código</label>
              <input
                type="text"
                value={otp}
                onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 8))}
                className={`${inputClass} text-center text-2xl tracking-widest font-mono`}
                placeholder="00000000"
                maxLength={8}
                required
                disabled={loading}
                inputMode="numeric"
              />
            </div>
            
            {/* Trust Device Checkbox - Per CONTEXT.md */}
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={trustDevice}
                onChange={(e) => setTrustDevice(e.target.checked)}
                className="w-5 h-5 rounded border-gray-300 text-[#262011] focus:ring-[#F5E1A4]"
              />
              <span className="text-sm text-[#262011]">
                Confiar en este dispositivo por 30 días
              </span>
            </label>
            
            <button type="submit" disabled={loading || otp.length !== 8} className={buttonClass}>
              {loading ? 'Verificando...' : 'Verificar'}
            </button>
            <div className="flex justify-between">
              <button type="button" onClick={handleResendOTP} disabled={loading || resendCooldown > 0} className={linkButtonClass}>
                {resendCooldown > 0 ? `Reenviar (${resendCooldown}s)` : 'Reenviar código'}
              </button>
              <button type="button" onClick={goBack} className={linkButtonClass} disabled={loading}>
                ← Volver
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
```

**Crear apps/admin/src/pages/SettingsPage.jsx:**

```jsx
// src/pages/SettingsPage.jsx
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import * as authApi from '../api/auth';

export default function SettingsPage() {
  const { user, token, logout } = useAuth();
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');

  const handleLogoutAll = async () => {
    if (!confirm('¿Cerrar sesión en todos los dispositivos? Tendrás que verificar con OTP la próxima vez.')) {
      return;
    }
    
    setLoading(true);
    setError('');
    setMessage('');
    
    try {
      const result = await authApi.logoutAll(token);
      
      if (result.error) {
        setError(result.error);
        return;
      }
      
      setMessage(result.message);
      
      // Logout current session after showing message
      setTimeout(() => {
        logout();
      }, 2000);
    } catch (err) {
      console.error('Logout all error:', err);
      setError('Error de conexión');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold text-[#262011] mb-6">Configuración</h1>
      
      {/* User Info */}
      <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h2 className="text-lg font-semibold text-[#262011] mb-4">Tu Cuenta</h2>
        <div className="space-y-2 text-sm">
          <p><span className="text-[#262011]/60">Usuario:</span> {user?.username}</p>
          <p><span className="text-[#262011]/60">Email:</span> {user?.email}</p>
          <p><span className="text-[#262011]/60">Rol:</span> {user?.role === 'developer' ? 'Desarrollador' : 'Administrador'}</p>
        </div>
      </div>
      
      {/* Security */}
      <div className="bg-white rounded-xl shadow-sm p-6">
        <h2 className="text-lg font-semibold text-[#262011] mb-4">Seguridad</h2>
        
        {message && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm">
            {message}
          </div>
        )}
        
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
            {error}
          </div>
        )}
        
        <p className="text-sm text-[#262011]/70 mb-4">
          Cierra sesión en todos tus dispositivos. La próxima vez que inicies sesión 
          desde cualquier dispositivo, necesitarás verificar con un código OTP.
        </p>
        
        <button
          onClick={handleLogoutAll}
          disabled={loading}
          className="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors min-h-[44px]"
        >
          {loading ? 'Cerrando sesiones...' : 'Cerrar todas las sesiones'}
        </button>
      </div>
    </div>
  );
}
```

**Actualizar apps/admin/src/App.jsx:**

```jsx
// src/App.jsx
import { useState } from 'react';
import { AuthProvider, useAuth } from './context/AuthContext';
import LoginPage from './pages/LoginPage';
import SettingsPage from './pages/SettingsPage';

function AdminContent() {
  const { isAuthenticated, loading, user, logout, isDeveloper } = useAuth();
  const [currentPage, setCurrentPage] = useState('dashboard');

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#FDF8E8]">
        <div className="text-[#262011]">Cargando...</div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return <LoginPage />;
  }

  return (
    <div className="min-h-screen bg-[#FDF8E8]">
      <header className="bg-[#262011] text-[#F5E1A4] p-4">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <h1 className="text-lg sm:text-xl font-bold">La Pan Comido - Admin</h1>
          <div className="flex items-center gap-2 sm:gap-4">
            <button
              onClick={() => setCurrentPage('settings')}
              className="text-sm opacity-80 hover:opacity-100"
            >
              {user?.username}
            </button>
            <button
              onClick={logout}
              className="px-3 py-1 bg-[#F5E1A4] text-[#262011] rounded text-sm font-medium hover:bg-[#F5E1A4]/90 min-h-[36px]"
            >
              Salir
            </button>
          </div>
        </div>
      </header>
      
      {/* Navigation */}
      <nav className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 flex gap-4">
          <button
            onClick={() => setCurrentPage('dashboard')}
            className={`py-3 px-2 text-sm font-medium border-b-2 -mb-px ${
              currentPage === 'dashboard' 
                ? 'border-[#262011] text-[#262011]' 
                : 'border-transparent text-[#262011]/60 hover:text-[#262011]'
            }`}
          >
            Dashboard
          </button>
          <button
            onClick={() => setCurrentPage('settings')}
            className={`py-3 px-2 text-sm font-medium border-b-2 -mb-px ${
              currentPage === 'settings' 
                ? 'border-[#262011] text-[#262011]' 
                : 'border-transparent text-[#262011]/60 hover:text-[#262011]'
            }`}
          >
            Configuración
          </button>
        </div>
      </nav>
      
      <main className="max-w-7xl mx-auto p-4 sm:p-6">
        {currentPage === 'dashboard' && (
          <div className="bg-white rounded-xl shadow-sm p-6 sm:p-8 text-center">
            <h2 className="text-xl sm:text-2xl font-bold text-[#262011] mb-2">
              ¡Bienvenido, {user?.username}!
            </h2>
            <p className="text-[#262011]/60 text-sm sm:text-base">
              El panel de administración estará disponible en la siguiente fase.
            </p>
            {isDeveloper && (
              <div className="mt-4 p-3 bg-blue-50 rounded-lg text-blue-700 text-sm">
                Tienes acceso de desarrollador.
              </div>
            )}
          </div>
        )}
        
        {currentPage === 'settings' && <SettingsPage />}
      </main>
    </div>
  );
}

function App() {
  return (
    <AuthProvider>
      <AdminContent />
    </AuthProvider>
  );
}

export default App;
```
  </action>
  <verify>
```bash
# Verify all files were created
ls -la apps/admin/src/api/auth.js apps/admin/src/context/AuthContext.jsx apps/admin/src/pages/LoginPage.jsx apps/admin/src/pages/SettingsPage.jsx

# Verify Turnstile installed
grep "@marsidev/react-turnstile" apps/admin/package.json

# Verify App.jsx structure
grep -E "(AuthProvider|LoginPage|SettingsPage)" apps/admin/src/App.jsx
```
Debe mostrar todos los archivos y las dependencias.
  </verify>
  <done>
- api/auth.js con todas las funciones de autenticación
- AuthContext.jsx con manejo de token
- LoginPage.jsx con Turnstile, flujo multi-step, trust checkbox
- SettingsPage.jsx con cerrar todas las sesiones
- App.jsx con navegación entre dashboard y settings
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verificar flujo completo de autenticación</name>
  <what-built>Sistema completo de autenticación OTP con UI de login, Turnstile, y settings</what-built>
  <how-to-verify>
**Prerequisitos:**
- Configurar TURNSTILE_SECRET_KEY en .env del API
- Configurar VITE_TURNSTILE_SITE_KEY en .env de admin
- (O dejar sin configurar para modo desarrollo)

1. Iniciar API y Admin:
   ```bash
   npm run dev
   ```
   
2. Abrir http://localhost:3002 (admin)

3. **Test 1 - Setup inicial (primer login):**
   - Login con "dev" + "dev2026!Temp"
   - Debe pedir email → ingresar uno real
   - Revisar email (o consola del API para OTP en dev)
   - Ingresar OTP de 8 dígitos
   - Crear contraseña nueva (cumplir requisitos)
   - Debe volver al login

4. **Test 2 - Login normal:**
   - Login con "dev" + contraseña nueva
   - Debe pedir OTP (dispositivo nuevo)
   - Marcar checkbox "Confiar en este dispositivo"
   - Verificar OTP
   - Debe entrar al dashboard

5. **Test 3 - Dispositivo confiable:**
   - Cerrar sesión
   - Login de nuevo
   - Debe entrar directo (sin OTP) porque el dispositivo es confiable

6. **Test 4 - Cerrar todas las sesiones:**
   - Ir a Configuración
   - Click "Cerrar todas las sesiones"
   - Confirmar
   - Debe cerrar sesión
   - Al hacer login de nuevo, debe pedir OTP

7. **Verificar UI:**
   - Mobile-first (probar en viewport pequeño)
   - Branding correcto (#F5E1A4, #262011)
   - Errores inline en rojo
   - Turnstile visible (si configurado)
  </how-to-verify>
  <resume-signal>Type "approved" si todo funciona, o describe los issues encontrados</resume-signal>
</task>

</tasks>

<verification>
```bash
# Verify all components
node -e "
const isDeveloper = require('./apps/api/src/middlewares/isDeveloper.js');
console.log('isDeveloper type:', typeof isDeveloper);
"

# Verify admin builds
cd apps/admin && npm run build 2>&1 | tail -5
```
</verification>

<success_criteria>
1. isDeveloper.js middleware existe y funciona
2. verifyTurnstile.js middleware valida tokens de Cloudflare
3. LoginPage.jsx tiene Turnstile integrado y flujo multi-step completo
4. Checkbox "Confiar en este dispositivo" aparece después de OTP
5. SettingsPage.jsx tiene botón "Cerrar todas las sesiones" funcional
6. UI es mobile-first con branding La Pan Comido
7. Errores se muestran inline bajo los campos
8. admin app compila sin errores
</success_criteria>

<output>
After completion, create `.planning/phases/05-autenticacion-otp/05-03-SUMMARY.md`
</output>
